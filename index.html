<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>ç‰¡è›äº§å“è°ƒç ”</title>
    
    <!-- æé€Ÿå›½å†…æº -->
    <script src="https://cdn.staticfile.org/vue/3.3.4/vue.global.prod.min.js"></script>
    
    <style>
        :root { --primary: #1677ff; --bg: #f5f7fa; --text: #1f2937; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background-color: var(--bg); color: var(--text); line-height: 1.5; }
        .app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: #fff; display: flex; flex-direction: column; }
        
        #loading { position: fixed; inset:0; background:#fff; z-index:999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        
        header { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: rgba(255,255,255,0.95); z-index: 100; }
        h1 { font-size: 16px; font-weight: 800; color: #333; margin: 0; }
        .progress-bar { height: 3px; background: #f0f0f0; width: 100%; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 0.3s ease; }
        main { flex: 1; padding: 20px 16px; overflow-y: auto; padding-bottom: 90px; }
        
        .q-keyword { font-size: 20px; font-weight: 900; color: #000; display: block; margin-bottom: 4px; }
        .q-context { font-size: 14px; color: #666; }
        .optional-tag { display: inline-block; font-size: 12px; background: #e6f4ff; color: #1677ff; padding: 1px 5px; border-radius: 4px; margin-left: 5px; }

        .option-card { padding: 14px 10px; border: 2px solid #f0f0f0; border-radius: 12px; background: #fff; text-align: center; font-size: 15px; font-weight: 500; color: #444; margin-bottom: 10px; cursor: pointer; }
        .option-card.selected { border-color: var(--primary); background-color: #e6f4ff; color: var(--primary); font-weight: 700; }

        .role-card { display: flex; align-items: center; padding: 24px; margin-bottom: 16px; border: 2px solid #f0f0f0; border-radius: 16px; background: #fff; }
        .role-icon { font-size: 40px; margin-right: 16px; }
        
        footer { position: fixed; bottom: 0; left: 0; right: 0; max-width: 600px; margin: 0 auto; padding: 12px 16px; background: rgba(255,255,255,0.9); border-top: 1px solid #f0f0f0; display: flex; gap: 12px; z-index: 50; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
        .btn { border-radius: 12px; font-size: 16px; border: none; font-weight: 700; cursor: pointer; height: 48px; display: flex; align-items: center; justify-content: center; }
        .btn-next { background: var(--primary); color: #fff; flex: 1; }
        .btn-prev { background: #f5f5f5; color: #999; width: 48px; }

        .status-page { text-align: center; padding-top: 40px; }
        .btn-copy { background: #333; color: white; width: 100%; margin-top: 10px; }
        
        textarea { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 10px; }
        input[type=range] { width: 100%; margin: 20px 0; }
        
        .ver-tag { font-size: 10px; color: #ddd; text-align: center; margin-top: 30px; }
    </style>
</head>
<body>

<div id="loading">
    <div style="font-size:30px;">ğŸš€</div>
    <p style="color:#666; font-size:12px; margin-top:10px;">åŠ è½½ä¸­...</p>
</div>

<div id="app" class="app-container" style="display:none">
    <header>
        <h1>ğŸ¯ ç‰¡è›è°ƒç ”</h1>
        <div v-if="step > 0 && step <= totalSteps" style="font-size:12px; color:#666">{{ step }}/{{ totalSteps }}</div>
    </header>
    <div class="progress-bar" v-if="step > 0 && step <= totalSteps">
        <div class="progress-fill" :style="{ width: progress + '%' }"></div>
    </div>

    <main>
        <!-- 0. è§’è‰² -->
        <div v-if="step === 0">
            <h2 style="text-align:center; margin:20px 0;">è¯·é€‰æ‹©æ‚¨çš„èº«ä»½</h2>
            <div class="role-card" @click="startSurvey('restaurant')">
                <span class="role-icon">ğŸ‘¨â€ğŸ³</span>
                <div><div style="font-weight:bold">é¤å…ç»è¥è€…</div><div style="font-size:13px; color:#666">é¤é¥®é‡‡è´­ / åå¨</div></div>
            </div>
            <div class="role-card" @click="startSurvey('consumer')">
                <span class="role-icon">ğŸ </span>
                <div><div style="font-weight:bold">å®¶åº­æ¶ˆè´¹è€…</div><div style="font-size:13px; color:#666">è‡ªå·±åšé¥­ / çˆ±å¥½è€…</div></div>
            </div>
            <!-- è¿™é‡Œçš„ç‰ˆæœ¬å·ä»…ä½œæ ‡è¯†ï¼Œä¸å½±å“åŠŸèƒ½ -->
            <div class="ver-tag">V23.0 æ­£å¼å‘å¸ƒç‰ˆ</div>
        </div>

        <!-- 1. é¢˜ç›® -->
        <div v-else-if="step > 0 && step <= totalSteps">
            <div class="q-wrapper">
                <span class="q-keyword">{{ currentQuestion.keyword }} <span v-if="currentQuestion.optional" class="optional-tag">é€‰å¡«</span></span>
                <span class="q-context">{{ currentQuestion.text }}</span>
            </div>

            <template v-if="['single', 'multiple'].includes(currentQuestion.type)">
                <div v-for="(opt, idx) in currentQuestion.options" :key="idx" 
                     @click="handleOptionClick(opt, currentQuestion.type)"
                     :class="['option-card', isSelected(opt) ? 'selected' : '']">
                    {{ opt }}
                </div>
            </template>

            <div v-if="currentQuestion.type === 'slider'" style="text-align:center; padding:20px; background:#fafafa; border-radius:10px;">
                <div style="font-size:32px; font-weight:900; color:#1677ff">Â¥ {{ tempAnswer }}</div>
                <div style="font-size:12px; color:#999">æ¯ç›’ (250g)</div>
                <input type="range" :min="currentQuestion.min" :max="currentQuestion.max" step="0.5" v-model="tempAnswer">
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#999">
                    <span>Â¥{{ currentQuestion.min }}</span><span>Â¥{{ currentQuestion.max }}</span>
                </div>
            </div>

            <div v-if="currentQuestion.type === 'text'">
                <textarea v-model="tempAnswer" rows="5" placeholder="è¯·è¾“å…¥..."></textarea>
            </div>
        </div>

        <!-- 2. ç»“æœé¡µ -->
        <div v-else class="status-page">
            <div v-if="isSubmitting">
                <div style="font-size:60px; animation:bounce 1s infinite">â˜ï¸</div>
                <h3>æ­£åœ¨ä¸Šä¼ ...</h3>
                <p style="color:#666; font-size:12px">æ•°æ®ä¼ è¾“è‡³å›½å†…èŠ‚ç‚¹</p>
            </div>

            <div v-else-if="submitSuccess">
                <div style="font-size:60px">âœ…</div>
                <h3 style="color:#1677ff">æäº¤æˆåŠŸ</h3>
                <p style="color:#666">æ•°æ®å·²è‡ªåŠ¨ä¿å­˜ï¼Œæ„Ÿè°¢æ‚¨çš„é…åˆã€‚</p>
                <button @click="resetSurvey" style="border:none; background:none; color:#1677ff; font-weight:bold; margin-top:20px;">å¡«å†™ä¸‹ä¸€ä»½</button>
            </div>

            <div v-else>
                <div style="font-size:60px">âŒ</div>
                <h3>æäº¤å¼‚å¸¸</h3>
                <div style="background:#fff0f0; color:red; padding:10px; font-size:11px; border-radius:8px; margin:10px 0; text-align:left; word-break:break-all;">
                    é”™è¯¯è¯¦æƒ…: {{ errorMsg }}
                </div>
                <button @click="copyData" class="btn btn-copy">ğŸ“‹ å¤åˆ¶æ•°æ® (æ‰‹åŠ¨å‘ç»™è°ƒç ”å‘˜)</button>
                <button @click="submitData" style="margin-top:20px; background:none; border:none; text-decoration:underline; color:#666">é‡è¯•</button>
            </div>
        </div>
    </main>

    <footer v-if="step > 0 && step <= totalSteps">
        <button @click="prevStep" class="btn btn-prev">â†</button>
        <button @click="nextStep" class="btn btn-next">
            {{ step === totalSteps ? 'æäº¤' : (currentQuestion.optional && !tempAnswer ? 'è·³è¿‡' : 'ä¸‹ä¸€é¢˜') }}
        </button>
    </footer>
</div>

<script>
    window.onload = function() { document.getElementById('loading').style.display = 'none'; document.getElementById('app').style.display = 'flex'; }

    const { createApp } = Vue;

    // ğŸ”´ Bmob å¯†é’¥ (ç¡®è®¤æ— è¯¯)
    const BMOB_APP_ID  = "dd9c39a27bd851237ad3b15f1298a836"; 
    const BMOB_REST_KEY = "e650c3cb314bb7a3e0f86384dce12b9f"; 

    const surveyDb = {
        restaurant: [
            { id: 'b_type', type: 'single', keyword: 'é¤å…ç±»å‹', text: 'æ‚¨ç»è¥çš„é¤å…å±äºå“ªä¸€ç±»ï¼Ÿ', options: ['çƒ§çƒ¤/å¤§æ’æ¡£', 'ä¸­å¼æ­£é¤', 'ç«é”…/ä¸²ä¸²', 'å¿«é¤/ç®€é¤', 'æµ·é²œç‰¹è‰²åº—', 'è‡ªåŠ©é¤'] },
            { id: 'b_current', type: 'single', keyword: 'ç›®å‰ç”¨æ–™', text: 'åº—å†…ä¸»è¦ä½¿ç”¨å“ªç§å½¢æ€çš„ç‰¡è›ï¼Ÿ', options: ['å¸¦å£³é²œæ´»', 'å†·å†»åŠå£³', 'å†·å†»çº¯è‚‰', 'æœªä½¿ç”¨'] },
            { id: 'b_pain', type: 'multiple', keyword: 'ä¸»è¦ç—›ç‚¹', text: 'ä½¿ç”¨é²œæ´»ç‰¡è›æ—¶æœ€å¤§çš„éº»çƒ¦ï¼Ÿ(å¤šé€‰)', options: ['äººå·¥å¼€å£³éš¾', 'æ­»äº¡æŸè€—é«˜', 'å¤§å°ä¸å‡', 'è‚¥åº¦ä¸ç¨³å®š', 'æœ‰ç©ºå£³/æ³¥æ²™'] },
            { id: 'b_dish', type: 'multiple', keyword: 'é¢„è®¡åšæ³•', text: 'å¦‚æœç”¨è¿™æ¬¾å†·å†»è‚‰ï¼Œè®¡åˆ’åšä»€ä¹ˆèœï¼Ÿ', options: ['èšµä»”ç…/é…¥ç‚¸', 'æµ·é²œç²¥/æ±¤', 'ç«é”…æ¶®ç…®', 'ä¸­å¼çˆ†ç‚’', 'é”¡çº¸/è’œè“‰çƒ¤'] },
            { id: 'b_pack', type: 'single', keyword: 'åŒ…è£…è§„æ ¼', text: 'å“ªç§å¤§å°æ–¹ä¾¿åå¨æ§æœ¬ï¼Ÿ(æ‰“æ ·250g)', options: ['250g (å°ä»½)', '500g (æ ‡å‡†)', '1kg (å¤§åŒ…)', '2.5kg (é‡è´©)'] },
            { id: 'b_price', type: 'slider', keyword: 'å¿ƒç†ä»·ä½', text: '250g/ç›’ (çº¦25ç²’) åˆç†è¿›è´§ä»·ï¼Ÿ', min: 5, max: 20 },
            { id: 'b_premium', type: 'single', keyword: 'æº¢ä»·æ„æ„¿', text: 'è‹¥åšåˆ°â€œä¸ç ´è‚šã€æ˜“è§£å†»â€ï¼Œæ„¿åŠ ä»·å—ï¼Ÿ', options: ['ä¸åŠ ä»·', 'åŠ  0.5-1å…ƒ', 'åŠ  1-2å…ƒ', 'åŠ  2å…ƒä»¥ä¸Š'] },
            { id: 'b_vol', type: 'single', keyword: 'æœˆé‡‡è´­é‡', text: 'è‹¥è¯•èœæ»¡æ„ï¼Œé¢„ä¼°æœˆé‡‡è´­é‡ï¼Ÿ', options: ['50æ–¤å†…', '50-200æ–¤', '200-500æ–¤', '500æ–¤+'] },
            { id: 'b_factor', type: 'multiple', keyword: 'ä¾›åº”å•†', text: 'é€‰ä¾›åº”å•†æœ€çœ‹é‡å“ªä¸¤ç‚¹ï¼Ÿ', options: ['ä»·æ ¼ä¾¿å®œ', 'ä¾›è´§ç¨³å®š', 'å“è´¨ä¸€è‡´', 'è´¦æœŸç»“ç®—', 'å”®åæœåŠ¡'] },
            { id: 'b_contact', type: 'text', keyword: 'è”ç³»æ–¹å¼', text: 'å¦‚æœ‰æ„è¯•æ ·ï¼Œè¯·ç•™ç”µè¯/åº—å', optional: true }
        ],
        consumer: [
            { id: 'c_freq', type: 'single', keyword: 'é£Ÿç”¨é¢‘ç‡', text: 'å¹³æ—¶å¤šä¹…åƒä¸€æ¬¡ç‰¡è›/ç”Ÿèšï¼Ÿ', options: ['æ¯å‘¨åƒ', 'æ¯æœˆ1-2æ¬¡', 'å‡ ä¸ªæœˆä¸€æ¬¡', 'å‡ ä¹ä¸åƒ'] },
            { id: 'c_habit', type: 'single', keyword: 'å¤„ç†ä¹ æƒ¯', text: 'åœ¨å®¶å¤„ç†æµ·é²œçš„æƒ…å†µï¼Ÿ', options: ['ç»å¸¸è‡ªå·±åš', 'å¶å°”å°è¯•', 'å«Œéº»çƒ¦/è„', 'åªåƒå¤–å–'] },
            { id: 'c_accept', type: 'single', keyword: 'æ¥å—åº¦', text: 'èƒ½æ¥å—â€œå»å£³çº¯è‚‰ç›’å†»â€å—ï¼Ÿ', options: ['éå¸¸å–œæ¬¢', 'å¯ä»¥æ¥å—', 'ä¸€èˆ¬', 'åªè®¤é²œæ´»'] },
            { id: 'c_eat', type: 'multiple', keyword: 'æ€ä¹ˆåƒ', text: 'å¦‚æœåœ¨å®¶é‡Œåšï¼Œä¸»è¦åšæ³•ï¼Ÿ', options: ['ç…®æ±¤/ç²¥', 'ç…è›‹/èšµä»”ç…', 'ç«é”…æ¶®èœ', 'ç©ºæ°”ç‚¸é”…', 'çˆ†ç‚’/çº¢çƒ§'] },
            { id: 'c_pack', type: 'single', keyword: 'åŒ…è£…åå¥½', text: 'å®¶åº­å¸¸å¤‡å€¾å‘å¤šå¤§åŒ…è£…ï¼Ÿ', options: ['250g (ä¸€é¡¿)', '500g (ä¸¤é¡¿)', '1kg (å¤§ä»½)'] },
            { id: 'c_price', type: 'slider', keyword: 'å¿ƒç†ä»·ä½', text: '250g/ç›’ èƒ½æ¥å—çš„æ—¥å¸¸ä»·æ ¼ï¼Ÿ', min: 5, max: 20 },
            { id: 'c_prem', type: 'single', keyword: 'å“è´¨æº¢ä»·', text: 'è‹¥åšåˆ°â€œæ˜“è§£å†»ã€ä¸ç ´è‚šâ€ï¼Œæ„¿å¤šä»˜é’±å—ï¼Ÿ', options: ['ä¸æ„¿æ„', 'è´µ 1-2å…ƒ', 'è´µ 3å…ƒä»¥ä¸Š'] },
            { id: 'c_worry', type: 'multiple', keyword: 'æœ€å¤§é¡¾è™‘', text: 'ç½‘è´­å†»å“æœ€æ‹…å¿ƒä»€ä¹ˆï¼Ÿ', options: ['å£æ„Ÿåƒæ£‰èŠ±', 'ç¼©æ°´ä¸¥é‡', 'è…¥å‘³é‡', 'ä¸ªå¤´å¤ªå°', 'è¿è¾“åŒ–å†»'] },
            { id: 'c_buy', type: 'single', keyword: 'è´­ä¹°æ¸ é“', text: 'é€šå¸¸åœ¨å“ªé‡Œä¹°ï¼Ÿ', options: ['ç”Ÿé²œAPP', 'äº¬ä¸œ/æ·˜å®', 'ç¤¾åŒºå›¢è´­', 'èœå¸‚åœº'] },
            { id: 'c_age', type: 'single', keyword: 'å¹´é¾„æ®µ', text: 'æ‚¨çš„å¹´é¾„èŒƒå›´ï¼Ÿ', options: ['18-25å²', '26-35å²', '36-45å²', '46å²ä»¥ä¸Š'] },
            { id: 'c_msg', type: 'text', keyword: 'å»ºè®®ç•™è¨€', text: 'ä»»ä½•å…³äºå£å‘³ã€åŒ…è£…çš„å»ºè®®ï¼Ÿ', optional: true }
        ]
    };

    createApp({
        data() {
            return { step: 0, role: null, answers: {}, tempAnswer: null, isSubmitting: false, submitSuccess: false, errorMsg: '' }
        },
        computed: {
            questions() { return this.role ? surveyDb[this.role] : []; },
            currentQuestion() { return this.questions[this.step - 1] || {}; },
            totalSteps() { return this.questions.length; },
            progress() { return this.step === 0 ? 0 : Math.round(((this.step - 1) / this.totalSteps) * 100); }
        },
        methods: {
            startSurvey(role) { this.role = role; this.step = 1; this.initTempAnswer(); },
            initTempAnswer() {
                const q = this.currentQuestion;
                if (!q.type) return;
                if (q.type === 'slider') this.tempAnswer = Math.floor((q.min + q.max) / 2);
                else if (q.type === 'multiple') this.tempAnswer = [];
                else this.tempAnswer = '';
            },
            handleOptionClick(opt, type) {
                if (type === 'single') { this.tempAnswer = opt; setTimeout(() => this.nextStep(), 150); }
                else { 
                    const idx = this.tempAnswer.indexOf(opt);
                    idx > -1 ? this.tempAnswer.splice(idx, 1) : this.tempAnswer.push(opt);
                }
            },
            isSelected(opt) { return Array.isArray(this.tempAnswer) ? this.tempAnswer.includes(opt) : this.tempAnswer === opt; },
            prevStep() { this.step > 1 ? (this.step--, this.initTempAnswer()) : this.step = 0; },
            nextStep() {
                if (!this.currentQuestion.optional) {
                    if (!this.tempAnswer || (Array.isArray(this.tempAnswer) && this.tempAnswer.length === 0)) return;
                }
                this.answers[this.currentQuestion.id] = this.tempAnswer;
                if(this.step < this.totalSteps) { this.step++; this.initTempAnswer(); }
                else { this.submitData(); }
            },
            async submitData() {
                this.step = this.totalSteps + 1;
                this.isSubmitting = true;
                
                const cleanAnswers = JSON.parse(JSON.stringify(this.answers));
                for(let k in cleanAnswers) if(cleanAnswers[k] == null) cleanAnswers[k] = "";
                
                const finalData = { 
                    role: this.role === 'restaurant' ? 'Bç«¯é¤é¥®' : 'Cç«¯æ¶ˆè´¹è€…', 
                    ...cleanAnswers 
                };

                try {
                    const response = await fetch(`https://api.bmobcloud.com/1/classes/SurveyData`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Bmob-Application-Id': BMOB_APP_ID,
                            'X-Bmob-REST-API-Key': BMOB_REST_KEY
                        },
                        body: JSON.stringify(finalData)
                    });

                    if (response.ok) {
                        this.submitSuccess = true;
                        this.isSubmitting = false;
                        // æˆåŠŸåä¸å¼¹çª—ï¼Œé™é»˜æˆåŠŸ
                    } else {
                        const err = await response.json();
                        throw new Error(err.error || "æœåŠ¡å™¨æ‹’ç»");
                    }
                } catch (error) {
                    this.isSubmitting = false;
                    this.errorMsg = error.message;
                }
            },
            copyData() {
                let txt = `ã€${this.role}ã€‘\n`;
                surveyDb[this.role].forEach(q => {
                    let v = this.answers[q.id];
                    if(Array.isArray(v)) v = v.join(',');
                    txt += `${q.keyword}: ${v || 'æœªå¡«'}\n`;
                });
                const input = document.createElement('textarea');
                input.value = txt; document.body.appendChild(input); input.select();
                try { document.execCommand('copy'); alert("âœ… å·²å¤åˆ¶ï¼"); } 
                catch(e) { alert("âŒ å¤åˆ¶å¤±è´¥"); }
                document.body.removeChild(input);
            },
            resetSurvey() { this.step = 0; this.role = null; this.answers = {}; this.submitSuccess = false; }
        }
    }).mount('#app');
</script>
</body>
</html>
