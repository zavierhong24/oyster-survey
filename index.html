<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- å¼ºåˆ¶ç¦æ­¢ç¼“å­˜ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>è‘¡è„ç‰™ç‰¡è›(è‚‰)äº§å“è°ƒç ”</title>
    
    <!-- å›½å†…æé€Ÿ CDN -->
    <script src="https://cdn.staticfile.org/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdn.staticfile.org/leancloud-storage/4.15.0/av-min.js"></script>
    
    <style>
        :root { --primary: #2563eb; --bg: #f5f7fa; --text: #1f2937; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background-color: var(--bg); color: var(--text); }
        .app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: #fff; display: flex; flex-direction: column; }
        
        /* å¤´éƒ¨ */
        header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #fff; z-index: 10; }
        h1 { font-size: 16px; font-weight: 700; }
        .progress-bar { height: 4px; background: #eee; width: 100%; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 0.3s ease; }

        /* å†…å®¹åŒº */
        main { flex: 1; padding: 20px; overflow-y: auto; padding-bottom: 80px; }
        .q-title { font-size: 19px; font-weight: 700; margin-bottom: 10px; line-height: 1.4; color: #111; }
        .q-tag { font-size: 12px; color: #fff; background: #2563eb; padding: 2px 6px; border-radius: 4px; vertical-align: middle; margin-right: 5px; }
        .q-sub { font-size: 13px; color: #666; background: #f3f4f6; padding: 8px 12px; border-radius: 6px; margin-bottom: 20px; display: inline-block; }
        .optional-tag { color: #059669; background: #d1fae5; margin-left: 5px; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: normal; }

        /* é€‰é¡¹å¡ç‰‡ */
        .option-card { display: flex; align-items: center; justify-content: space-between; padding: 16px; margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 12px; background: #fff; transition: all 0.15s; cursor: pointer; }
        .option-card:active { background-color: #f8fafc; transform: scale(0.98); }
        .option-card.selected { border-color: var(--primary); background-color: #eff6ff; color: var(--primary); font-weight: 600; box-shadow: 0 2px 8px rgba(37,99,235,0.15); }
        .check-icon { display: none; color: var(--primary); font-weight: bold; font-size: 18px; }
        .option-card.selected .check-icon { display: block; }
        
        /* è§’è‰²å¡ç‰‡ */
        .role-card { display: flex; align-items: center; padding: 25px; margin-bottom: 20px; border: 1px solid #e5e7eb; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .role-card:active { transform: scale(0.96); }
        .role-icon { font-size: 36px; margin-right: 15px; }
        
        /* æ»‘å— */
        .slider-box { background: #f8fafc; padding: 30px 20px; border-radius: 16px; text-align: center; border: 1px solid #e2e8f0; }
        .price-display { font-size: 36px; font-weight: 800; color: var(--primary); margin-bottom: 5px; }
        input[type=range] { width: 100%; margin: 25px 0; height: 6px; background: #cbd5e1; border-radius: 5px; -webkit-appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 28px; height: 28px; background: #2563eb; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }

        /* åº•éƒ¨æŒ‰é’® */
        footer { position: fixed; bottom: 0; left: 0; right: 0; max-width: 600px; margin: 0 auto; padding: 15px 20px; background: #fff; border-top: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; z-index: 20; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        .btn { padding: 12px 24px; border-radius: 10px; font-size: 15px; border: none; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .btn-prev { background: #f3f4f6; color: #666; }
        .btn-next { background: var(--primary); color: #fff; flex: 1; margin-left: 15px; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
        .btn-next:active { opacity: 0.8; }
        
        /* çŠ¶æ€é¡µ */
        .status-page { text-align: center; padding: 40px 20px; }
        .status-icon { font-size: 64px; margin-bottom: 20px; display: block; }
        .action-btn { display: block; width: 100%; padding: 16px; margin-top: 15px; border-radius: 10px; border: none; font-weight: bold; font-size: 15px; cursor: pointer; text-align: center; text-decoration: none; }
        .btn-retry { background: #374151; color: white; }
        .btn-csv { background: #059669; color: white; box-shadow: 0 4px 12px rgba(5,150,105,0.3); }
        
        .version-tag { text-align: center; font-size: 12px; color: red; font-weight: bold; padding: 20px; }
    </style>
</head>
<body>

<div id="app" class="app-container">

    <!-- é¡¶éƒ¨ -->
    <header>
        <h1>ğŸ¦ª äº§å“è°ƒç ”</h1>
        <div style="font-size:12px; color:#999;" v-if="step > 0 && step <= totalSteps">{{ step }} / {{ totalSteps }}</div>
    </header>
    <div class="progress-bar" v-if="step > 0 && step <= totalSteps">
        <div class="progress-fill" :style="{ width: progress + '%' }"></div>
    </div>

    <main>
        <!-- 0. è§’è‰²é€‰æ‹© -->
        <div v-if="step === 0" style="padding-top: 20px;">
            <div style="text-align:center; margin-bottom:30px;">
                <h2 style="font-size:22px; color:#111;">è¯·é€‰æ‹©æ‚¨çš„èº«ä»½</h2>
                <p style="color:#666; font-size:14px; margin-top:5px;">æˆ‘ä»¬å°†ä¸ºæ‚¨å®šåˆ¶ä¸“å±é—®é¢˜</p>
            </div>
            <div class="role-card" @click="startSurvey('restaurant')">
                <div class="role-icon">ğŸ‘¨â€ğŸ³</div>
                <div><div style="font-weight:bold; font-size:17px;">é¤å…ç»è¥è€…</div><div style="font-size:13px; color:#666; margin-top:4px;">Bç«¯ï¼šé‡‡è´­ / åå¨ / è€æ¿</div></div>
            </div>
            <div class="role-card" @click="startSurvey('consumer')">
                <div class="role-icon">ğŸ </div>
                <div><div style="font-weight:bold; font-size:17px;">å®¶åº­æ¶ˆè´¹è€…</div><div style="font-size:13px; color:#666; margin-top:4px;">Cç«¯ï¼šè‡ªå·±åšé¥­ / æµ·é²œçˆ±å¥½è€…</div></div>
            </div>
            <!-- ğŸ”´ ç‰ˆæœ¬å·ï¼šå¦‚æœæ²¡çœ‹åˆ°è¿™è¡Œçº¢å­—ï¼Œè¯´æ˜æ‚¨è¿˜åœ¨ç”¨æ—§ç¼“å­˜ -->
            <div class="version-tag">å½“å‰ç‰ˆæœ¬: V4.4 (ä¿®å¤ç™½å±)</div>
        </div>

        <!-- 1. ç­”é¢˜ä¸­ -->
        <div v-else-if="step > 0 && step <= totalSteps">
            <div class="q-title">
                <span class="q-tag">Q{{ step }}</span>{{ currentQuestion.text }}
                <span v-if="currentQuestion.optional" class="optional-tag">é€‰å¡«</span>
            </div>
            <div v-if="currentQuestion.sub" class="q-sub">ğŸ’¡ {{ currentQuestion.sub }}</div>

            <!-- é€‰é¡¹ -->
            <template v-if="['single', 'multiple'].includes(currentQuestion.type)">
                <div v-for="(opt, idx) in currentQuestion.options" :key="idx" 
                     @click="handleOptionClick(opt, currentQuestion.type)"
                     :class="['option-card', isSelected(opt) ? 'selected' : '']">
                    <span>{{ opt }}</span>
                    <span class="check-icon">âœ“</span>
                </div>
            </template>

            <!-- æ»‘å— -->
            <div v-if="currentQuestion.type === 'slider'" class="slider-box">
                <div class="price-display">Â¥ {{ tempAnswer }}</div>
                <div style="font-size:13px; color:#64748b; margin-bottom:20px;">æ¯ç›’(250g)é¢„æœŸä»·æ ¼</div>
                <input type="range" :min="currentQuestion.min" :max="currentQuestion.max" step="0.5" v-model="tempAnswer">
                <div style="display:flex; justify-content:space-between; color:#999; font-size:12px;">
                    <span>Â¥{{ currentQuestion.min }}</span><span>Â¥{{ currentQuestion.max }}</span>
                </div>
            </div>

            <!-- æ–‡æœ¬ -->
            <div v-if="currentQuestion.type === 'text'">
                <textarea v-model="tempAnswer" rows="6" style="width:100%; padding:15px; border:1px solid #ddd; border-radius:12px; font-size:16px; outline:none; background:#fafafa;" placeholder="è¯·è¾“å…¥æ‚¨çš„æƒ³æ³•..."></textarea>
            </div>
        </div>

        <!-- 2. çŠ¶æ€é¡µ (step > totalSteps) -->
        <div v-else class="status-page">
            <div v-if="isSubmitting">
                <div class="status-icon" style="animation: bounce 1s infinite;">ğŸ”„</div>
                <h3>æ­£åœ¨ä¸Šä¼ æ•°æ®...</h3>
                <p style="color:#666; font-size:13px;">è¯·å‹¿å…³é—­é¡µé¢ï¼Œæ­£åœ¨è¿æ¥æœåŠ¡å™¨</p>
            </div>

            <div v-else-if="submitSuccess">
                <div class="status-icon">ğŸ‰</div>
                <h3 style="color:#059669;">æäº¤æˆåŠŸï¼</h3>
                <p style="color:#666; margin-bottom:30px; line-height:1.6;">
                    æ„Ÿè°¢æ‚¨çš„å®è´µå»ºè®®ã€‚<br>æˆ‘ä»¬å·²æ”¶åˆ°æ‚¨çš„åé¦ˆã€‚
                </p>
                <button @click="resetSurvey" style="background:none; border:none; color:var(--primary); font-weight:bold; padding:10px;">å¡«å†™ä¸‹ä¸€ä»½</button>
            </div>

            <div v-else>
                <div class="status-icon">ğŸ“¡</div>
                <h3>ç½‘ç»œè¿æ¥ä¸ç¨³å®š</h3>
                <p style="color:#666; font-size:13px; margin-bottom:20px; line-height:1.5;">
                    è™½ç„¶è¿æ¥äº‘ç«¯è¶…æ—¶ï¼Œä½†åˆ«æ‹…å¿ƒï¼<br>
                    <strong>è¯·ç‚¹å‡»ç»¿è‰²æŒ‰é’®ç›´æ¥ä¸‹è½½æ•°æ®æ–‡ä»¶ã€‚</strong>
                </p>
                <button @click="exportCSV" class="action-btn btn-csv">ğŸ“¥ ä¿å­˜æ•°æ®æ–‡ä»¶ (ç¡®ä¿æ•°æ®ä¸ä¸¢å¤±)</button>
                <button @click="submitData" class="action-btn btn-retry" style="margin-top:10px; background:transparent; color:#666; font-weight:normal; border:1px solid #eee;">é‡è¯•æäº¤</button>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <footer v-if="step > 0 && step <= totalSteps">
        <button @click="prevStep" class="btn btn-prev">ä¸Šä¸€é¢˜</button>
        <button @click="nextStep" class="btn btn-next">
            {{ getNextBtnText() }}
        </button>
    </footer>

</div>

<script>
    const { createApp } = Vue;

    // LeanCloud Config
    const APP_ID = "1iqfzTWgx6IhUOvjOGt5HSqg-MdYXbMMI";
    const APP_KEY = "7r3MYrx91UJEoVBrj1sVATOV";
    const SERVER_URL = "https://1iqfztwg.api.lncldglobal.com";

    try {
        if(typeof AV !== 'undefined') {
            AV.init({ appId: APP_ID, appKey: APP_KEY, serverURLs: SERVER_URL });
        }
    } catch (e) { console.error("Init Error", e); }

    const surveyDb = {
        restaurant: [
            { id: 'b_type', type: 'single', text: 'æ‚¨ç»è¥çš„é¤å…ç±»å‹æ˜¯ï¼Ÿ', options: ['çƒ§çƒ¤ / å¤§æ’æ¡£', 'ä¸­å¼æ­£é¤ / ç‚’èœ', 'ç«é”… / ä¸²ä¸²', 'å¿«é¤ / ç®€é¤', 'æµ·é²œç‰¹è‰²åº—', 'è‡ªåŠ©é¤'] },
            { id: 'b_current_use', type: 'single', text: 'æ‚¨ç›®å‰åº—å†…ä¸»è¦ä½¿ç”¨çš„ç‰¡è›å½¢æ€ï¼Ÿ', options: ['å¸¦å£³é²œæ´»ç‰¡è›', 'å†·å†»åŠå£³ç‰¡è›', 'å†·å†»ç‰¡è›è‚‰', 'ç›®å‰æœªä½¿ç”¨'] },
            { id: 'b_problem', type: 'multiple', text: 'ä½¿ç”¨é²œæ´»ç‰¡è›æ—¶ï¼Œé‡åˆ°çš„ä¸»è¦é—®é¢˜ï¼Ÿ', sub: 'å¯å¤šé€‰', options: ['äººå·¥å¼€å£³å¤ªéº»çƒ¦', 'æ­»äº¡ç‡é«˜/æŸè€—å¤§', 'ä¸ªå¤´å¤§å°ä¸å‡åŒ€', 'å“è´¨/è‚¥åº¦ä¸ç¨³å®š', 'å®¹æ˜“æœ‰ç©ºå£³/æ³¥æ²™'] },
            { id: 'b_dish', type: 'multiple', text: 'å¦‚æœä½¿ç”¨è¿™æ¬¾å†·å†»ç‰¡è›è‚‰ï¼Œè®¡åˆ’åšä»€ä¹ˆèœï¼Ÿ', sub: 'æˆ‘ä»¬çš„äº§å“ä¸å»ºè®®ç”Ÿé£Ÿ', options: ['èšµä»”ç… / é…¥ç‚¸', 'æµ·é²œç²¥ / æ±¤ç¾¹', 'ç«é”…æ¶®ç…®', 'ä¸­å¼çˆ†ç‚’ (å®«ä¿/è’œè“‰)', 'é”¡çº¸çƒ¤ (åŠ è’œè“‰ç²‰ä¸)'] },
            { id: 'b_weight_pref', type: 'single', text: 'å“ªç§åŒ…è£…è§„æ ¼æœ€æ–¹ä¾¿åå¨ä½¿ç”¨ï¼Ÿ', sub: 'å½“å‰æ‰“æ ·ä¸º 250g/ç›’', options: ['250g (å°ä»½è£…ï¼Œä¸€ä»½èœ)', '500g (æ ‡å‡†è£…)', '1kg (å¤§åŒ…è£…)', '2.5kg (é‡è´©è£…)'] },
            { id: 'b_price_accept', type: 'slider', text: 'æŒ‰ 250g/ç›’ è§„æ ¼ï¼Œåˆç†çš„è¿›è´§ä»·æ˜¯å¤šå°‘ï¼Ÿ', sub: 'å†…å«çº¦20-30ç²’è‚‰', min: 5, max: 20 },
            { id: 'b_premium', type: 'single', text: 'è‹¥åšåˆ°â€œä¸ç ´è‚šã€å•ä½“æ˜“è§£å†»â€ï¼Œæ„¿æ„åŠ ä»·å—ï¼Ÿ', options: ['ä¸æ„¿æ„ï¼Œåªçœ‹æœ€ä½ä»·', 'æ„¿æ„æ¯ç›’åŠ  0.5-1 å…ƒ', 'æ„¿æ„æ¯ç›’åŠ  1-2 å…ƒ', 'æ„¿æ„æ¯ç›’åŠ  2 å…ƒä»¥ä¸Š'] },
            { id: 'b_volume', type: 'single', text: 'å¦‚æœè¯•èœæ»¡æ„ï¼Œé¢„ä¼°æœˆé‡‡è´­é‡ï¼Ÿ', options: ['50æ–¤ä»¥å†…', '50-200æ–¤', '200-500æ–¤', '500æ–¤ä»¥ä¸Š'] },
            { id: 'b_supplier', type: 'multiple', text: 'é€‰æ‹©ä¾›åº”å•†æœ€çœ‹é‡å“ªä¸¤ç‚¹ï¼Ÿ', sub: 'è¯·é€‰æ‹©æœ€é‡è¦çš„ 2 é¡¹', options: ['ä»·æ ¼ç»å¯¹ä¾¿å®œ', 'ä¾›è´§ç¨³å®šæ€§', 'å“è´¨ä¸€è‡´æ€§', 'è´¦æœŸ/ç»“ç®—æ–¹å¼', 'å”®åæœåŠ¡'] },
            { id: 'b_contact', type: 'text', text: 'ï¼ˆé€‰å¡«ï¼‰å¦‚æœ‰æ„å‘è¯•æ ·ï¼Œè¯·ç•™ä¸‹æ‚¨çš„è”ç³»æ–¹å¼æˆ–åº—åï¼š', sub: 'æ–¹ä¾¿æˆ‘ä»¬å¯„é€æ ·å“ï¼Œä¸å¡«å¯è·³è¿‡', optional: true }
        ],
        consumer: [
            { id: 'c_freq', type: 'single', text: 'æ‚¨å¹³æ—¶åƒç‰¡è›/ç”Ÿèšçš„é¢‘ç‡ï¼Ÿ', options: ['æ¯å‘¨éƒ½ä¼šåƒ', 'æ¯æœˆ1-2æ¬¡', 'å‡ ä¸ªæœˆæ‰åƒä¸€æ¬¡', 'å‡ ä¹ä¸æ€ä¹ˆåƒ'] },
            { id: 'c_habit', type: 'single', text: 'æ‚¨åœ¨å®¶è‡ªå·±å¤„ç†æµ·é²œçš„ä¹ æƒ¯ï¼Ÿ', options: ['ç»å¸¸ä¸‹å¨è‡ªå·±åš', 'å¶å°”å°è¯•ç®€å•åšæ³•', 'è§‰å¾—éº»çƒ¦/è„', 'åªåƒå¤–å–æˆ–å»é¤å…'] },
            { id: 'c_form_accept', type: 'single', text: 'èƒ½å¦æ¥å—â€œå»å£³çº¯è‚‰ç›’å†»â€äº§å“ï¼Ÿ', options: ['éå¸¸å–œæ¬¢ (æ— å£³æ— åƒåœ¾)', 'å¯ä»¥æ¥å— (çœ‹æ€§ä»·æ¯”)', 'ä¸€èˆ¬ (è§‰å¾—ä¸å¦‚é²œæ´»)', 'ä¸æ¥å— (åªè®¤é²œæ´»)'] },
            { id: 'c_scene', type: 'multiple', text: 'å¦‚æœåœ¨å®¶é‡Œåšï¼Œæ‚¨ä¸»è¦ä¼šæ€ä¹ˆåƒï¼Ÿ', options: ['ç…®æµ·é²œæ±¤ / ç…®ç²¥', 'ç…è›‹ / èšµä»”ç…', 'å®¶åº­ç«é”… / æ¶®èœ', 'ç©ºæ°”ç‚¸é”… / çƒ¤ç®±', 'çˆ†ç‚’ / çº¢çƒ§'] },
            { id: 'c_weight_pref', type: 'single', text: 'å®¶åº­å¸¸å¤‡é£Ÿæï¼Œå€¾å‘å¤šå¤§çš„åŒ…è£…ï¼Ÿ', options: ['200g-250g (ä¸€é¡¿åƒå®Œ)', '400g-500g (ä¸‰å£ä¹‹å®¶)', '1kg (å¤§ä»½å®æƒ )'] },
            { id: 'c_price_accept', type: 'slider', text: 'ä¸€ç›’ 250g ç‰¡è›è‚‰ï¼Œèƒ½æ¥å—çš„æ—¥å¸¸ä»·æ ¼ï¼Ÿ', sub: 'æ‹–åŠ¨æ»‘å—è®¾ç½®', min: 5, max: 20 },
            { id: 'c_quality_pay', type: 'single', text: 'è‹¥äº§å“åšåˆ°â€œå®¹æ˜“è§£å†»ã€ä¸ç ´è‚šâ€ï¼Œæ‚¨æ„¿æ„æ¯”èœå¸‚åœºç»Ÿè´§è´µä¸€ç‚¹å—ï¼Ÿ', options: ['ä¸æ„¿æ„ï¼Œè¶Šä¾¿å®œè¶Šå¥½', 'æ„¿æ„æ¯ç›’è´µ 1-2 å…ƒ (å¹²å‡€æ–¹ä¾¿)', 'æ„¿æ„æ¯ç›’è´µ 3 å…ƒä»¥ä¸Š (ç—›æ¨ä¸å¹²å‡€)'] },
            { id: 'c_concern', type: 'multiple', text: 'ç½‘è´­å†·å†»ç”Ÿèšï¼Œæœ€å¤§çš„é¡¾è™‘æ˜¯ï¼Ÿ', options: ['å£æ„Ÿåƒâ€œæ£‰èŠ±â€', 'åŒ–å†»åç¼©æ°´ä¸¥é‡', 'æœ‰è…¥å‘³/ä¸æ–°é²œ', 'ä¸ªå¤´å¤ªå°/ç¢è‚‰å¤š', 'å†·é“¾è¿è¾“åŒ–å†»'] },
            { id: 'c_channel', type: 'single', text: 'æ‚¨é€šå¸¸ä¹ æƒ¯åœ¨å“ªé‡Œè´­ä¹°æ­¤ç±»é£Ÿæï¼Ÿ', options: ['ç”Ÿé²œAPP (ç›’é©¬/æœ´æœ´)', 'ç½‘è´­ (äº¬ä¸œ/æ·˜å®)', 'ç¤¾åŒºå›¢è´­', 'çº¿ä¸‹è¶…å¸‚/èœå¸‚åœº'] },
            { id: 'c_demographic', type: 'single', text: 'æ‚¨çš„å¹´é¾„æ®µï¼Ÿ', options: ['18-25å²', '26-35å²', '36-45å²', '46å²ä»¥ä¸Š'] },
            { id: 'c_comment', type: 'text', text: 'ï¼ˆé€‰å¡«ï¼‰æœ€åï¼Œæ‚¨è¿˜æœ‰ä»€ä¹ˆå»ºè®®æˆ–æƒ³å¯¹æˆ‘ä»¬è¯´çš„å—ï¼Ÿ', sub: 'ä»»ä½•å…³äºå£å‘³ã€åŒ…è£…ã€æœåŠ¡çš„å»ºè®®', optional: true }
        ]
    };

    createApp({
        data() {
            return { step: 0, role: null, answers: {}, tempAnswer: null, isSubmitting: false, submitSuccess: false }
        },
        computed: {
            questions() { return this.role ? surveyDb[this.role] : []; },
            currentQuestion() { 
                // å®‰å…¨é”ï¼šé˜²æ­¢æº¢å‡ºå¯¼è‡´ç™½å±
                if (!this.questions || this.step > this.totalSteps) return {};
                return this.questions[this.step - 1]; 
            },
            totalSteps() { return this.questions.length; },
            progress() { return this.step === 0 ? 0 : Math.round(((this.step - 1) / this.totalSteps) * 100); }
        },
        methods: {
            startSurvey(role) { this.role = role; this.step = 1; this.initTempAnswer(); },
            initTempAnswer() {
                const q = this.currentQuestion;
                if (!q || !q.type) return; 
                if (q.type === 'slider') this.tempAnswer = Math.floor((q.min + q.max) / 2);
                else if (q.type === 'multiple') this.tempAnswer = [];
                else this.tempAnswer = '';
            },
            handleOptionClick(opt, type) {
                if (type === 'single') {
                    this.tempAnswer = opt;
                    setTimeout(() => { this.nextStep() }, 200);
                } else if (type === 'multiple') {
                    const idx = this.tempAnswer.indexOf(opt);
                    idx > -1 ? this.tempAnswer.splice(idx, 1) : this.tempAnswer.push(opt);
                }
            },
            isSelected(opt) { return Array.isArray(this.tempAnswer) ? this.tempAnswer.includes(opt) : this.tempAnswer === opt; },
            prevStep() { this.step > 1 ? (this.step--, this.initTempAnswer()) : this.step = 0; },
            
            nextStep() {
                if (!this.currentQuestion.optional) {
                    if (!this.tempAnswer || (Array.isArray(this.tempAnswer) && this.tempAnswer.length === 0)) return;
                }
                this.answers[this.currentQuestion.id] = this.tempAnswer;
                
                if(this.step < this.totalSteps) {
                    this.step++;
                    this.initTempAnswer();
                } else {
                    this.submitData();
                }
            },
            
            getNextBtnText() {
                if (this.step === this.totalSteps) return 'æäº¤é—®å·';
                if (this.currentQuestion.optional && (!this.tempAnswer || this.tempAnswer.length===0)) return 'è·³è¿‡ / ä¸‹ä¸€é¢˜';
                return 'ä¸‹ä¸€é¢˜';
            },

            async submitData() {
                // ğŸš€ é˜²ç™½å±æ ¸å¿ƒä¿®å¤ï¼šç«‹å³åˆ‡æ¢è§†å›¾çŠ¶æ€
                this.step = this.totalSteps + 1; 
                this.isSubmitting = true;
                
                const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 15000));
                
                const cleanAnswers = JSON.parse(JSON.stringify(this.answers));
                for(let k in cleanAnswers) {
                    if(cleanAnswers[k] === null || cleanAnswers[k] === undefined) cleanAnswers[k] = "";
                }

                const finalData = { 
                    role: this.role === 'restaurant' ? 'Bç«¯é¤é¥®' : 'Cç«¯æ¶ˆè´¹è€…', 
                    timestamp: new Date(), 
                    ...cleanAnswers 
                };

                try {
                    const savePromise = new Promise(async (resolve, reject) => {
                        try {
                            const SurveyObject = AV.Object.extend('SurveyData');
                            const survey = new SurveyObject();
                            for (const key in finalData) survey.set(key, finalData[key]);
                            await survey.save();
                            resolve();
                        } catch(e) { reject(e); }
                    });

                    await Promise.race([savePromise, timeout]);
                    this.submitSuccess = true;
                } catch (error) {
                    console.error("Submit Failed:", error);
                    this.submitSuccess = false; 
                } finally {
                    this.isSubmitting = false;
                }
            },
            exportCSV() {
                let csvContent = "\uFEFFKey,Value\n";
                for (const [key, value] of Object.entries(this.answers)) {
                    let valStr = value;
                    if(valStr === null || valStr === undefined) valStr = "";
                    if(Array.isArray(valStr)) valStr = valStr.join(';');
                    if(typeof valStr === 'string') valStr = valStr.replace(/\n/g, " ");
                    csvContent += `${key},"${valStr}"\n`;
                }
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
                link.download = `data_${Date.now()}.csv`;
                link.click();
            },
            resetSurvey() { this.step = 0; this.role = null; this.answers = {}; this.submitSuccess = false; }
        }
    }).mount('#app');
</script>
</body>
</html>
