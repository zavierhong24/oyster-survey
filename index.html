<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‘¡è„ç‰™ç‰¡è›(è‚‰)äº§å“è°ƒç ”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- å¼•å…¥ LeanCloud SDK -->
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* åŸºç¡€æ ·å¼ä¼˜åŒ– */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤å¾®ä¿¡ç‚¹å‡»é«˜äº® */
        }
        
        /* é€‰é¡¹å¡ç‰‡ï¼šå¢å¤§ç‚¹å‡»çƒ­åŒºï¼Œå¢å¼ºåé¦ˆ */
        .option-card {
            transition: transform 0.1s, background-color 0.2s;
            position: relative;
        }
        .option-card:active { 
            transform: scale(0.98); 
            background-color: #e5e7eb; 
        }
        .option-card.selected {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        /* ä¿®å¤æ»‘å—åœ¨ç§»åŠ¨ç«¯çš„è§¦æ‘¸ä½“éªŒ */
        input[type=range] {
            -webkit-appearance: none; width: 100%; height: 6px;
            background: #cbd5e1; border-radius: 5px; outline: none;
            padding: 0; margin: 10px 0;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 30px; height: 30px; /* åŠ å¤§æ»‘å—æŒ‰é’® */
            border-radius: 50%; background: #2563eb;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2); border: 2px solid white;
        }

        /* åŠ è½½åŠ¨ç”» */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px; height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="app" class="flex flex-col min-h-screen max-w-lg mx-auto bg-white shadow-xl overflow-hidden relative">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white p-4 border-b border-gray-100 flex justify-between items-center sticky top-0 z-20">
        <h1 class="text-base font-bold text-gray-800">ğŸ¦ª äº§å“è°ƒç ”</h1>
        <div class="text-xs text-gray-400" v-if="step > 0 && !isFinished">{{ step }} / {{ totalSteps }}</div>
    </header>

    <!-- è¿›åº¦æ¡ -->
    <div class="h-1 bg-gray-100 w-full" v-if="step > 0 && !isFinished">
        <div class="h-full bg-blue-600 transition-all duration-300" :style="{ width: progress + '%' }"></div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-grow p-5 overflow-y-auto pb-20">
        
        <!-- 0. è§’è‰²é€‰æ‹© -->
        <div v-if="step === 0" class="flex flex-col justify-center h-full pt-10">
            <h2 class="text-xl font-bold text-center text-gray-800 mb-8">è¯·é€‰æ‹©æ‚¨çš„èº«ä»½</h2>
            <div class="space-y-4">
                <div @click="startSurvey('restaurant')" class="option-card p-5 rounded-xl border border-gray-200 shadow-sm flex items-center cursor-pointer">
                    <span class="text-3xl mr-4">ğŸ‘¨â€ğŸ³</span>
                    <div>
                        <div class="font-bold text-gray-900">é¤å…ç»è¥è€…</div>
                        <div class="text-xs text-gray-500">é¤é¥®é‡‡è´­ / åå¨ / è€æ¿</div>
                    </div>
                </div>
                <div @click="startSurvey('consumer')" class="option-card p-5 rounded-xl border border-gray-200 shadow-sm flex items-center cursor-pointer">
                    <span class="text-3xl mr-4">ğŸ </span>
                    <div>
                        <div class="font-bold text-gray-900">å®¶åº­æ¶ˆè´¹è€…</div>
                        <div class="text-xs text-gray-500">è‡ªå·±åšé¥­ / æµ·é²œçˆ±å¥½è€…</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 1. ç­”é¢˜ä¸­ -->
        <div v-else-if="!isFinished">
            <div class="mb-6">
                <h3 class="text-lg font-bold text-gray-900 leading-relaxed">{{ currentQuestion.text }}</h3>
                <p v-if="currentQuestion.sub" class="text-sm text-gray-500 mt-2 bg-gray-50 p-2 rounded inline-block">
                    {{ currentQuestion.sub }}
                </p>
            </div>

            <div class="space-y-3">
                <!-- é€‰é¡¹åˆ—è¡¨ -->
                <template v-if="['single', 'multiple'].includes(currentQuestion.type)">
                    <div v-for="(opt, idx) in currentQuestion.options" :key="idx"
                         @click="handleOptionClick(opt, currentQuestion.type)"
                         :class="['option-card p-4 rounded-lg border flex items-center justify-between cursor-pointer', 
                                  isSelected(opt) ? 'bg-blue-50 border-blue-500 text-blue-700' : 'bg-white border-gray-200 text-gray-700']">
                        <span class="font-medium text-sm">{{ opt }}</span>
                        <i v-if="isSelected(opt)" class="fas fa-check-circle text-blue-500"></i>
                    </div>
                </template>

                <!-- æ»‘å— -->
                <div v-if="currentQuestion.type === 'slider'" class="py-8 px-2 bg-gray-50 rounded-xl text-center border border-gray-200">
                    <div class="text-3xl font-bold text-blue-700 mb-2">Â¥ {{ tempAnswer }}</div>
                    <div class="text-xs text-gray-400 mb-6">æ¯ç›’(250g)é¢„æœŸä»·æ ¼</div>
                    <input type="range" :min="currentQuestion.min" :max="currentQuestion.max" step="0.5" v-model="tempAnswer">
                    <div class="flex justify-between text-xs text-gray-400 mt-2 px-1">
                        <span>Â¥{{ currentQuestion.min }}</span>
                        <span>Â¥{{ currentQuestion.max }}</span>
                    </div>
                </div>

                <!-- æ–‡æœ¬æ¡† -->
                <div v-if="currentQuestion.type === 'text'">
                    <textarea v-model="tempAnswer" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="è¯·è¾“å…¥..."></textarea>
                </div>
            </div>
        </div>

        <!-- 2. ç»“æŸ/æäº¤é¡µ -->
        <div v-else class="flex flex-col items-center justify-center pt-10 text-center">
            
            <!-- æäº¤ä¸­çŠ¶æ€ -->
            <div v-if="isSubmitting">
                <div class="spinner mb-4"></div>
                <h3 class="font-bold text-gray-800">æ­£åœ¨ä¸Šä¼ æ•°æ®...</h3>
                <p class="text-xs text-gray-500 mt-2">ç½‘ç»œå¯èƒ½è¾ƒæ…¢ï¼Œè¯·è€å¿ƒç­‰å¾… 5 ç§’</p>
            </div>

            <!-- æˆåŠŸçŠ¶æ€ -->
            <div v-else-if="submitSuccess">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-500 text-4xl">âœ“</div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">æäº¤æˆåŠŸï¼</h2>
                <p class="text-sm text-gray-500 mb-8">æ„Ÿè°¢æ‚¨çš„æ—¶é—´ï¼Œæ•°æ®å·²ä¿å­˜ã€‚</p>
                <button @click="resetSurvey" class="text-blue-600 text-sm font-bold">å¡«å†™ä¸‹ä¸€ä»½</button>
            </div>

            <!-- å¤±è´¥çŠ¶æ€ (å¸¦CSVå…œåº•) -->
            <div v-else>
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-2xl">!</div>
                <h2 class="text-lg font-bold text-gray-800 mb-2">ç½‘ç»œè¿æ¥è¶…æ—¶</h2>
                <p class="text-xs text-gray-500 mb-6 px-4">å¾®ä¿¡ä¸å›½é™…æœåŠ¡å™¨è¿æ¥ä¸ç•…ï¼Œè¿™å¾ˆæ­£å¸¸ã€‚<br>è¯·ç›´æ¥ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸‹è½½æ•°æ®æ–‡ä»¶ã€‚</p>
                
                <button @click="submitData" class="w-full py-3 bg-gray-800 text-white rounded-lg font-bold mb-3 shadow-md">å†è¯•ä¸€æ¬¡</button>
                <button @click="exportCSV" class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold shadow-md flex items-center justify-center gap-2">
                    <i class="fas fa-download"></i> å¿…é¡»ç‚¹å‡»ï¼šä¿å­˜æ•°æ®æ–‡ä»¶
                </button>
            </div>
        </div>

    </main>

    <!-- åº•éƒ¨å›ºå®šæŒ‰é’®åŒº -->
    <footer v-if="step > 0 && !isFinished" class="bg-white p-4 border-t border-gray-100 fixed bottom-0 left-0 right-0 max-w-lg mx-auto z-20 flex justify-between items-center shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <button @click="prevStep" class="px-4 py-2 text-gray-400 text-sm font-medium hover:text-gray-600">ä¸Šä¸€é¢˜</button>
        <button @click="nextStep" 
                :disabled="!canProceed"
                :class="['px-6 py-2 rounded-lg text-sm font-bold transition-all', canProceed ? 'bg-blue-600 text-white shadow-lg active:scale-95' : 'bg-gray-200 text-gray-400']">
            {{ step === totalSteps ? 'æäº¤é—®å·' : 'ä¸‹ä¸€é¢˜' }}
        </button>
    </footer>

</div>

<script>
    const { createApp } = Vue;

    // LeanCloud é…ç½®
    const APP_ID = "1iqfzTWgx6IhUOvjOGt5HSqg-MdYXbMMI";
    const APP_KEY = "7r3MYrx91UJEoVBrj1sVATOV";
    const SERVER_URL = "https://1iqfztwg.api.lncldglobal.com";

    // åˆå§‹åŒ–æ•°æ®åº“
    try {
        if(typeof AV !== 'undefined') {
            AV.init({ appId: APP_ID, appKey: APP_KEY, serverURLs: SERVER_URL });
        }
    } catch (e) { console.error("LeanCloud Init Error", e); }

    const surveyDb = {
        restaurant: [
            { id: 'b_type', type: 'single', text: 'æ‚¨ç»è¥çš„é¤å…ç±»å‹æ˜¯ï¼Ÿ', options: ['çƒ§çƒ¤ / å¤§æ’æ¡£', 'ä¸­å¼æ­£é¤ / ç‚’èœ', 'ç«é”… / ä¸²ä¸²', 'å¿«é¤ / ç®€é¤', 'æµ·é²œç‰¹è‰²åº—', 'è‡ªåŠ©é¤'] },
            { id: 'b_current_use', type: 'single', text: 'æ‚¨ç›®å‰åº—å†…ä¸»è¦ä½¿ç”¨çš„ç‰¡è›å½¢æ€ï¼Ÿ', options: ['å¸¦å£³é²œæ´»ç‰¡è›', 'å†·å†»åŠå£³ç‰¡è›', 'å†·å†»ç‰¡è›è‚‰', 'ç›®å‰æœªä½¿ç”¨'] },
            { id: 'b_problem', type: 'multiple', text: 'ä½¿ç”¨é²œæ´»ç‰¡è›æ—¶ï¼Œé‡åˆ°çš„ä¸»è¦é—®é¢˜ï¼Ÿ', sub: 'å¯å¤šé€‰', options: ['äººå·¥å¼€å£³å¤ªéº»çƒ¦', 'æ­»äº¡ç‡é«˜/æŸè€—å¤§', 'ä¸ªå¤´å¤§å°ä¸å‡åŒ€', 'å“è´¨/è‚¥åº¦ä¸ç¨³å®š', 'å®¹æ˜“æœ‰ç©ºå£³/æ³¥æ²™'] },
            { id: 'b_dish', type: 'multiple', text: 'å¦‚æœä½¿ç”¨è¿™æ¬¾å†·å†»ç‰¡è›è‚‰ï¼Œè®¡åˆ’åšä»€ä¹ˆèœï¼Ÿ', sub: 'æˆ‘ä»¬çš„äº§å“ä¸å»ºè®®ç”Ÿé£Ÿ', options: ['èšµä»”ç… / é…¥ç‚¸', 'æµ·é²œç²¥ / æ±¤ç¾¹', 'ç«é”…æ¶®ç…®', 'ä¸­å¼çˆ†ç‚’ (å®«ä¿/è’œè“‰)', 'é”¡çº¸çƒ¤ (åŠ è’œè“‰ç²‰ä¸)'] },
            { id: 'b_weight_pref', type: 'single', text: 'å“ªç§åŒ…è£…è§„æ ¼æœ€æ–¹ä¾¿åå¨ä½¿ç”¨ï¼Ÿ', sub: 'å½“å‰æ‰“æ ·ä¸º 250g/ç›’', options: ['250g (å°ä»½è£…ï¼Œä¸€ä»½èœ)', '500g (æ ‡å‡†è£…)', '1kg (å¤§åŒ…è£…)', '2.5kg (é‡è´©è£…)'] },
            { id: 'b_price_accept', type: 'slider', text: 'æŒ‰ 250g/ç›’ è§„æ ¼ï¼Œåˆç†çš„è¿›è´§ä»·æ˜¯å¤šå°‘ï¼Ÿ', sub: 'å†…å«çº¦20-30ç²’è‚‰', min: 5, max: 20 },
            { id: 'b_premium', type: 'single', text: 'è‹¥åšåˆ°â€œä¸ç ´è‚šã€å•ä½“æ˜“è§£å†»â€ï¼Œæ„¿æ„åŠ ä»·å—ï¼Ÿ', options: ['ä¸æ„¿æ„ï¼Œåªçœ‹æœ€ä½ä»·', 'æ„¿æ„åŠ  0.5-1 å…ƒ', 'æ„¿æ„åŠ  1-2 å…ƒ', 'æ„¿æ„åŠ  2 å…ƒä»¥ä¸Š'] },
            { id: 'b_volume', type: 'single', text: 'å¦‚æœè¯•èœæ»¡æ„ï¼Œé¢„ä¼°æœˆé‡‡è´­é‡ï¼Ÿ', options: ['50æ–¤ä»¥å†…', '50-200æ–¤', '200-500æ–¤', '500æ–¤ä»¥ä¸Š'] },
            { id: 'b_supplier', type: 'multiple', text: 'é€‰æ‹©ä¾›åº”å•†æœ€çœ‹é‡å“ªä¸¤ç‚¹ï¼Ÿ', sub: 'è¯·é€‰æ‹©æœ€é‡è¦çš„ 2 é¡¹', options: ['ä»·æ ¼ç»å¯¹ä¾¿å®œ', 'ä¾›è´§ç¨³å®šæ€§', 'å“è´¨ä¸€è‡´æ€§', 'è´¦æœŸ/ç»“ç®—æ–¹å¼', 'å”®åæœåŠ¡'] },
            { id: 'b_contact', type: 'text', text: 'å¦‚æœ‰æ„å‘è¯•æ ·ï¼Œè¯·ç•™ä¸‹è”ç³»æ–¹å¼æˆ–åº—å', sub: 'é€‰å¡«' }
        ],
        consumer: [
            { id: 'c_freq', type: 'single', text: 'æ‚¨å¹³æ—¶åƒç‰¡è›/ç”Ÿèšçš„é¢‘ç‡ï¼Ÿ', options: ['æ¯å‘¨éƒ½ä¼šåƒ', 'æ¯æœˆ1-2æ¬¡', 'å‡ ä¸ªæœˆæ‰åƒä¸€æ¬¡', 'å‡ ä¹ä¸æ€ä¹ˆåƒ'] },
            { id: 'c_habit', type: 'single', text: 'æ‚¨åœ¨å®¶è‡ªå·±å¤„ç†æµ·é²œçš„ä¹ æƒ¯ï¼Ÿ', options: ['ç»å¸¸ä¸‹å¨è‡ªå·±åš', 'å¶å°”å°è¯•ç®€å•åšæ³•', 'è§‰å¾—éº»çƒ¦/è„', 'åªåƒå¤–å–æˆ–å»é¤å…'] },
            { id: 'c_form_accept', type: 'single', text: 'èƒ½å¦æ¥å—â€œå»å£³çº¯è‚‰ç›’å†»â€äº§å“ï¼Ÿ', options: ['éå¸¸å–œæ¬¢ (æ— å£³æ— åƒåœ¾)', 'å¯ä»¥æ¥å— (çœ‹æ€§ä»·æ¯”)', 'ä¸€èˆ¬ (è§‰å¾—ä¸å¦‚é²œæ´»)', 'ä¸æ¥å— (åªè®¤é²œæ´»)'] },
            { id: 'c_scene', type: 'multiple', text: 'å¦‚æœåœ¨å®¶é‡Œåšï¼Œæ‚¨ä¸»è¦ä¼šæ€ä¹ˆåƒï¼Ÿ', options: ['ç…®æµ·é²œæ±¤ / ç…®ç²¥', 'ç…è›‹ / èšµä»”ç…', 'å®¶åº­ç«é”… / æ¶®èœ', 'ç©ºæ°”ç‚¸é”… / çƒ¤ç®±', 'çˆ†ç‚’ / çº¢çƒ§'] },
            { id: 'c_weight_pref', type: 'single', text: 'å®¶åº­å¸¸å¤‡é£Ÿæï¼Œå€¾å‘å¤šå¤§çš„åŒ…è£…ï¼Ÿ', options: ['200g-250g (ä¸€é¡¿åƒå®Œ)', '400g-500g (ä¸‰å£ä¹‹å®¶)', '1kg (å¤§ä»½å®æƒ )'] },
            { id: 'c_price_accept', type: 'slider', text: 'ä¸€ç›’ 250g ç‰¡è›è‚‰ï¼Œèƒ½æ¥å—çš„æ—¥å¸¸ä»·æ ¼ï¼Ÿ', sub: 'æ‹–åŠ¨æ»‘å—è®¾ç½®', min: 5, max: 20 },
            { id: 'c_quality_pay', type: 'single', text: 'è‹¥äº§å“â€œæ— å†°è¡£ã€ä¸ç ´è‚šâ€ï¼Œæ„¿æ„è´µä¸€ç‚¹å—ï¼Ÿ', options: ['ä¸æ„¿æ„ï¼Œè¶Šä¾¿å®œè¶Šå¥½', 'æ„¿æ„ï¼Œåªè¦å¹²å‡€æ–¹ä¾¿', 'éå¸¸æ„¿æ„ï¼Œç—›æ¨ä¸å¹²å‡€'] },
            { id: 'c_concern', type: 'multiple', text: 'ç½‘è´­å†·å†»ç”Ÿèšï¼Œæœ€å¤§çš„é¡¾è™‘æ˜¯ï¼Ÿ', options: ['å£æ„Ÿåƒâ€œæ£‰èŠ±â€', 'åŒ–å†»åç¼©æ°´ä¸¥é‡', 'æœ‰è…¥å‘³/ä¸æ–°é²œ', 'ä¸ªå¤´å¤ªå°/ç¢è‚‰å¤š', 'å†·é“¾è¿è¾“åŒ–å†»'] },
            { id: 'c_channel', type: 'single', text: 'æ‚¨é€šå¸¸ä¹ æƒ¯åœ¨å“ªé‡Œè´­ä¹°æ­¤ç±»é£Ÿæï¼Ÿ', options: ['ç”Ÿé²œAPP (ç›’é©¬/æœ´æœ´)', 'ç½‘è´­ (äº¬ä¸œ/æ·˜å®)', 'ç¤¾åŒºå›¢è´­', 'çº¿ä¸‹è¶…å¸‚/èœå¸‚åœº'] },
            { id: 'c_demographic', type: 'single', text: 'æ‚¨çš„å¹´é¾„æ®µï¼Ÿ', options: ['18-25å²', '26-35å²', '36-45å²', '46å²ä»¥ä¸Š'] }
        ]
    };

    createApp({
        data() {
            return {
                step: 0,
                role: null,
                answers: {},
                tempAnswer: null,
                isSubmitting: false,
                submitSuccess: false
            }
        },
        computed: {
            questions() { return this.role ? surveyDb[this.role] : []; },
            currentQuestion() { return this.questions[this.step - 1]; },
            totalSteps() { return this.questions.length; },
            progress() { return this.step === 0 ? 0 : Math.round(((this.step - 1) / this.totalSteps) * 100); },
            canProceed() {
                if (this.currentQuestion?.type === 'slider') return true;
                if (!this.tempAnswer) return false;
                if (Array.isArray(this.tempAnswer) && this.tempAnswer.length === 0) return false;
                return true;
            }
        },
        methods: {
            startSurvey(role) { this.role = role; this.step = 1; this.initTempAnswer(); },
            initTempAnswer() {
                const q = this.currentQuestion;
                if (!q) return;
                if (q.type === 'slider') this.tempAnswer = Math.floor((q.min + q.max) / 2);
                else if (q.type === 'multiple') this.tempAnswer = [];
                else this.tempAnswer = '';
            },
            handleOptionClick(opt, type) {
                if (type === 'single') {
                    this.tempAnswer = opt;
                    // ã€ä¿®å¤1ã€‘è¿™é‡Œå»æ‰äº†å»¶æ—¶ï¼Œç›´æ¥ç”±ç”¨æˆ·ç‚¹ä¸‹é¢çš„â€œä¸‹ä¸€é¢˜â€æŒ‰é’®
                    // æˆ–è€…ä¿ç•™æçŸ­å»¶æ—¶ï¼Œç¡®ä¿å¾®ä¿¡å“åº”
                    setTimeout(() => { this.nextStep() }, 150); 
                } else if (type === 'multiple') {
                    const idx = this.tempAnswer.indexOf(opt);
                    idx > -1 ? this.tempAnswer.splice(idx, 1) : this.tempAnswer.push(opt);
                }
            },
            isSelected(opt) {
                return Array.isArray(this.tempAnswer) ? this.tempAnswer.includes(opt) : this.tempAnswer === opt;
            },
            prevStep() { this.step > 1 ? (this.step--, this.initTempAnswer()) : this.step = 0; },
            nextStep() {
                this.answers[this.currentQuestion.id] = this.tempAnswer;
                if(this.step < this.totalSteps) {
                    this.step++;
                    this.initTempAnswer();
                } else {
                    this.submitData();
                }
            },
            async submitData() {
                this.isSubmitting = true;
                
                // ã€ä¿®å¤2ã€‘å¢åŠ  6ç§’ è¶…æ—¶æœºåˆ¶
                // å¦‚æœ 6ç§’ å†…æ•°æ®åº“æ²¡ååº”ï¼Œç›´æ¥ç®—å¤±è´¥ï¼Œè®©ç”¨æˆ·å»ä¸‹è½½CSV
                const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 6000));
                
                const finalData = { role: this.role === 'restaurant' ? 'Bç«¯é¤é¥®' : 'Cç«¯æ¶ˆè´¹è€…', timestamp: new Date(), ...this.answers };

                try {
                    const savePromise = new Promise(async (resolve, reject) => {
                        try {
                            const SurveyObject = AV.Object.extend('SurveyData');
                            const survey = new SurveyObject();
                            for (const key in finalData) survey.set(key, finalData[key]);
                            await survey.save();
                            resolve();
                        } catch(e) { reject(e); }
                    });

                    // æ¯”èµ›ï¼šçœ‹æ˜¯å…ˆä¿å­˜æˆåŠŸï¼Œè¿˜æ˜¯å…ˆè¶…æ—¶
                    await Promise.race([savePromise, timeout]);
                    
                    this.submitSuccess = true;
                } catch (error) {
                    console.error("Submit Failed:", error);
                    this.submitSuccess = false; // è¿›å…¥å¤±è´¥é¡µé¢
                } finally {
                    this.isSubmitting = false;
                    this.step++; // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½è·³åˆ°ç»“æŸé¡µ
                }
            },
            exportCSV() {
                let csvContent = "\uFEFFKey,Value\n";
                for (const [key, value] of Object.entries(this.answers)) {
                    csvContent += `${key},"${Array.isArray(value) ? value.join(';') : value}"\n`;
                }
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
                link.download = `survey_${Date.now()}.csv`;
                link.click();
            }
        }
    }).mount('#app');
</script>
</body>
</html>